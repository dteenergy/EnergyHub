/**
 * This module contains SAP Malware Scanning Service
 * @link https://api.sap.com/api/MalwareScanAPI/cloud-sdk/JavaScript
 * 
 */

const {DefaultApi} = require('../external/service/MalwareScanAPI');
// const destinations = require('../../destinations');  // Use this for local testing

/**
 * Scan file to find malware
 * @param {BinaryType} file 
 * @returns {ack}  ack
 * @throws {Error}
 */
const scanfile = async (file) =>{
    try {
        const ack = await DefaultApi.createScan(file)
            .addCustomHeaders({ 'Content-Type': 'application/octet-stream' })
            .addCustomHeaders({ 'Accept': 'application/json' })
            .execute({destinationName:'dteConsentAppPortal-malwarescanner-dest'});
            // .execute(destinations['dteConsentAppPortal-malwarescanner-dest']);    // Use this for local testing

        // Verify that malware and encrypted content are not detected
        if(!ack.malwareDetected && !ack.encryptedContentDetected) return ack;

        // Construct error object
        const error = new Error (JSON.stringify({ack}));
        error.name = "SAP Malware Scanning Service Scan Error:";
        error.code = "400";
        throw error;
    } catch (error) {
        console.error(error);
        throw error
    }
}

module.exports = {
    scanfile
}